<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker (PWA)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#005a9c"/>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        h1, h2 { color: #005a9c; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        #tracking-status { font-weight: bold; text-align: center; padding: 10px; margin-bottom: 15px; border-radius: 4px; color: #333; background-color: #ffe0b2; display: none; }
        .tracking-active { background-color: #e0f7fa; color: #00796b; border: 1px solid #00bcd4; display: block !important; }
        .btn-start { background-color: #4CAF50; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-end { background-color: #FF5722; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-secondary { background-color: #6c757d; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-export { background-color: #1a73e8; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-danger { background-color: #dc3545; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-reset { background-color: #6a1b9a; color: white; width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        ul { list-style-type: none; padding-left: 0; }
        #project-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        #project-list li button { background: none; border: 1px solid #dc3545; color: #dc3545; border-radius: 4px; cursor: pointer; font-size: 12px; padding: 3px 6px; }
        .entry-item { background-color: #f9f9f9; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; margin-bottom: 10px; }
        .entry-item strong { color: #005a9c; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Time Tracker (START/END)</h1>

        <div class="card">
            <h2>Měření času</h2>
            <div id="tracking-status"></div>
            <div class="form-group">
                <label for="project-select">Zakázka:</label>
                <select id="project-select" required></select>
            </div>
            <button id="toggle-tracking-btn" class="btn-start">START MĚŘENÍ</button>
        </div>

        <div class="card">
            <h2>Správa zakázek</h2>
            <form id="project-form">
                <div class="form-group">
                    <label for="new-project-name">Název nové zakázky:</label>
                    <input type="text" id="new-project-name" placeholder="Např. 'Projekt Alfa'" required>
                </div>
                <button type="submit" class="btn-secondary">Přidat zakázku</button>
            </form>
            <h3>Existující zakázky:</h3>
            <ul id="project-list"></ul>
        </div>

        <div class="card">
            <h2>Historie záznamů</h2>
            <div id="entries-list"><p>Zatím žádné záznamy.</p></div>
            <button id="export-history" class="btn-export">Export do CSV (pro Excel)</button>
            <button id="clear-history" class="btn-danger">Smazat historii</button>
            <button id="reset-application" class="btn-reset">RESET APLIKACE (Vše smazat)</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('SW OK'))
                .catch(err => console.error('SW Error', err));
        }

        const projectForm = document.getElementById('project-form');
        const newProjectNameInput = document.getElementById('new-project-name');
        const projectList = document.getElementById('project-list');
        const projectSelect = document.getElementById('project-select');
        const entriesList = document.getElementById('entries-list');
        const clearHistoryButton = document.getElementById('clear-history');
        const exportHistoryButton = document.getElementById('export-history');
        const resetApplicationButton = document.getElementById('reset-application');
        const toggleTrackingBtn = document.getElementById('toggle-tracking-btn');
        const trackingStatus = document.getElementById('tracking-status');

        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let timeEntries = JSON.parse(localStorage.getItem('timeEntries')) || [];
        let activeTracking = JSON.parse(localStorage.getItem('activeTracking'));

        function saveProjects() { localStorage.setItem('projects', JSON.stringify(projects)); }

        function renderProjects() {
            const currentSelection = projectSelect.value;
            projectList.innerHTML = '';
            projectSelect.innerHTML = '';

            if (projects.length === 0) {
                projectSelect.innerHTML = '<option value="" disabled selected>Nejdříve přidejte zakázku</option>';
            } else {
                projectSelect.innerHTML = '<option value="" disabled>-- Vyberte zakázku --</option>';
            }

            projects.forEach((project, index) => {
                const li = document.createElement('li');
                li.textContent = project;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Smazat';
                deleteButton.onclick = () => deleteProject(index);
                deleteButton.disabled = (activeTracking && activeTracking.project === project);
                li.appendChild(deleteButton);
                projectList.appendChild(li);

                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSelect.appendChild(option);
            });

            if (activeTracking) {
                projectSelect.value = activeTracking.project;
                projectSelect.disabled = true;
            } else {
                projectSelect.disabled = false;
                if (currentSelection && projects.includes(currentSelection)) {
                    projectSelect.value = currentSelection;
                } else if (projects.length > 0) {
                    projectSelect.value = projects[0];
                }
            }
        }

        function addProject(event) {
            event.preventDefault();
            const projectName = newProjectNameInput.value.trim();
            if (projectName && !projects.includes(projectName)) {
                projects.push(projectName);
                projects.sort();
                saveProjects();
                renderProjects();
                updateTrackingUI();
                newProjectNameInput.value = '';
            }
        }

        function deleteProject(index) {
            const projectName = projects[index];
            projects.splice(index, 1);
            saveProjects();
            timeEntries = timeEntries.filter(entry => entry.project !== projectName);
            localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
            renderProjects();
            renderTimeEntries();
            updateTrackingUI();
        }

        function updateTrackingUI() {
            if (activeTracking) {
                toggleTrackingBtn.textContent = 'UKONČIT MĚŘENÍ (END)';
                toggleTrackingBtn.className = 'btn-end';
                const startTime = new Date(activeTracking.start);
                trackingStatus.innerHTML = `Měření: <strong>${activeTracking.project}</strong> <br> Od: ${startTime.toLocaleTimeString()}`;
                trackingStatus.classList.add('tracking-active');
            } else {
                toggleTrackingBtn.textContent = 'START MĚŘENÍ';
                toggleTrackingBtn.className = 'btn-start';
                trackingStatus.classList.remove('tracking-active');
                if (projects.length === 0) {
                    toggleTrackingBtn.disabled = true;
                    trackingStatus.textContent = 'Přidejte zakázku!';
                    trackingStatus.classList.add('tracking-active');
                } else {
                    toggleTrackingBtn.disabled = false;
                }
            }
        }

        function toggleTracking() {
            if (!activeTracking) {
                const selectedProject = projectSelect.value;
                if (!selectedProject) return;
                activeTracking = { project: selectedProject, start: new Date().toISOString() };
                localStorage.setItem('activeTracking', JSON.stringify(activeTracking));
            } else {
                const endTime = new Date();
                const startTime = new Date(activeTracking.start);
                const diffMins = Math.round((endTime - startTime) / 60000);
                timeEntries.push({
                    project: activeTracking.project,
                    start: activeTracking.start,
                    end: endTime.toISOString(),
                    minutes: diffMins
                });
                localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
                activeTracking = null;
                localStorage.removeItem('activeTracking');
                renderTimeEntries();
            }
            updateTrackingUI();
            renderProjects();
        }

        function renderTimeEntries() {
            entriesList.innerHTML = '';
            if (timeEntries.length === 0) {
                entriesList.innerHTML = '<p>Zatím žádné záznamy.</p>';
                exportHistoryButton.disabled = true;
                return;
            }
            exportHistoryButton.disabled = false;
            [...timeEntries].reverse().forEach(entry => {
                const div = document.createElement('div');
                div.className = 'entry-item';
                const hours = (entry.minutes / 60).toFixed(2);
                div.innerHTML = `<strong>${entry.project}</strong>: ${entry.minutes} min (${hours} h)<br><small>${new Date(entry.start).toLocaleString()} - ${new Date(entry.end).toLocaleTimeString()}</small>`;
                entriesList.appendChild(div);
            });
        }

        async function exportToCSV() {
            if (timeEntries.length === 0) return;
            const header = 'Zakazka;Start;Konec;Minuty;Hodiny';
            const rows = timeEntries.map(e => `"${e.project}";"${new Date(e.start).toLocaleString()}";"${new Date(e.end).toLocaleString()}";${e.minutes};${(e.minutes/60).toFixed(2).replace('.',',')}`).join('\n');
            const csv = "\ufeff" + header + '\n' + rows;

            try {
                if (window.Capacitor && window.Capacitor.Plugins.Filesystem) {
                    const { Filesystem, Share } = window.Capacitor.Plugins;
                    const result = await Filesystem.writeFile({
                        path: 'export.csv',
                        data: csv,
                        directory: 'CACHE',
                        encoding: 'utf8'
                    });
                    await Share.share({ title: 'Export', url: result.uri });
                } else {
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'export.csv';
                    link.click();
                }
            } catch (err) { alert("Chyba: " + err.message); }
        }

        function resetApp() {
            if(confirm("Opravdu vše smazat?")) {
                localStorage.clear();
                location.reload();
            }
        }

        projectForm.addEventListener('submit', addProject);
        toggleTrackingBtn.addEventListener('click', toggleTracking);
        clearHistoryButton.addEventListener('click', () => { timeEntries=[]; localStorage.removeItem('timeEntries'); renderTimeEntries(); });
        exportHistoryButton.addEventListener('click', exportToCSV);
        resetApplicationButton.addEventListener('click', resetApp);
        projectSelect.addEventListener('change', updateTrackingUI);

        renderProjects();
        renderTimeEntries();
        updateTrackingUI();
    });
    </script>
</body>
</html>
